package org.digijava.kernel.validation.activity;

import static org.hamcrest.Matchers.allOf;
import static org.hamcrest.Matchers.anything;
import static org.hamcrest.Matchers.contains;
import static org.hamcrest.Matchers.containsInAnyOrder;
import static org.hamcrest.Matchers.emptyIterable;
import static org.hamcrest.Matchers.equalTo;
import static org.hamcrest.Matchers.hasEntry;
import static org.hamcrest.Matchers.hasProperty;
import static org.hamcrest.Matchers.hasToString;
import static org.hamcrest.Matchers.isA;
import static org.junit.Assert.assertThat;

import java.util.Set;

import com.google.common.collect.ImmutableSet;
import org.digijava.kernel.ampapi.endpoints.activity.FMService;
import org.digijava.kernel.ampapi.endpoints.activity.TestFMService;
import org.digijava.kernel.ampapi.endpoints.activity.TestFieldInfoProvider;
import org.digijava.kernel.ampapi.endpoints.activity.field.APIField;
import org.digijava.kernel.ampapi.endpoints.activity.field.FieldsEnumerator;
import org.digijava.kernel.ampapi.endpoints.common.TestTranslatorService;
import org.digijava.kernel.validation.ConstraintViolation;
import org.digijava.kernel.validation.Path;
import org.digijava.kernel.validation.Validator;
import org.digijava.kernel.validators.activity.ComponentFundingOrgRoleValidator;
import org.digijava.module.aim.dbentity.AmpActivity;
import org.digijava.module.aim.dbentity.AmpActivityFields;
import org.digijava.module.aim.dbentity.AmpComponent;
import org.digijava.module.aim.dbentity.AmpComponentFunding;
import org.digijava.module.aim.dbentity.AmpOrgRole;
import org.digijava.module.aim.helper.Constants;
import org.hamcrest.Matcher;
import org.junit.Test;

/**
 * @author Octavian Ciubotaru
 */
public class ComponentFundingOrgRoleValidatorTest {

    @Test
    public void testNothingToValidate() {
        AmpActivity activity = new AmpActivity();

        APIField activityField = getMetaModel();

        assertThat(getViolations(activityField, activity), emptyIterable());
    }

    @Test
    public void testOneUndeclaredOrg() {
        AmpActivity activity = activityWithOneUndeclaredOrg();

        APIField activityField = getMetaModel();

        assertThat(getViolations(activityField, activity), contains(violationFor(1L)));
    }

    @Test
    public void testOneUndeclaredOrgInMultipleTransactions() {
        AmpActivity activity = activityWithOneUndeclaredOrgInManyTransactions();

        APIField activityField = getMetaModel();

        Set<ConstraintViolation> violations = getViolations(activityField, activity);
        assertThat(violations, contains(violationFor(1L)));
    }

    @Test
    public void testOneUndeclaredOrgMultiplePaths() {
        AmpActivity activity = activityWithOneUndeclaredOrgWithDifferentPaths();

        APIField activityField = getMetaModel();

        Set<ConstraintViolation> violations = getViolations(activityField, activity);
        assertThat(violations, containsInAnyOrder(
                violationFor(1L, path("components~commitments~component_organization")),
                violationFor(1L, path("components~disbursements~component_organization"))));
    }

    /**
     * Matches constraint violations generated by {@link ComponentFundingOrgRoleValidator}. Path is not verified.
     * @param orgId offending organization id
     * @return
     */
    private Matcher<ConstraintViolation> violationFor(Long orgId) {
        return violationFor(orgId, anything());
    }

    /**
     * Matches constraint violations generated by {@link ComponentFundingOrgRoleValidator}.
     * @param orgId offending organization id
     * @param pathMatcher matcher for path
     * @return constraint violation matcher
     */
    private Matcher<ConstraintViolation> violationFor(Long orgId, Matcher pathMatcher) {
        return allOf(
                isA(ConstraintViolation.class),
                hasProperty("constraintDescriptor",
                        hasProperty("constraintValidatorClass", equalTo(ComponentFundingOrgRoleValidator.class))),
                hasProperty("attributes", hasEntry(ComponentFundingOrgRoleValidator.ATTR_ORG_ID, orgId)),
                hasProperty("path", pathMatcher));
    }

    private Matcher<Path> path(String path) {
        return hasToString(path);
    }

    @Test
    public void testTwoOrgsNotDeclared() {
        AmpActivity activity = activityWithTwoUndeclaredOrgs();

        APIField activityField = getMetaModel();

        Set<ConstraintViolation> violations = getViolations(activityField, activity);
        assertThat(violations, containsInAnyOrder(
                violationFor(1L),
                violationFor(3L)));
    }

    @Test
    public void testDeclaredOrg() {
        HardcodedOrgs orgs = new HardcodedOrgs();
        HardcodedRoles roles = new HardcodedRoles();

        AmpComponentFunding funding1 = new AmpComponentFunding();
        funding1.setTransactionType(Constants.COMMITMENT);
        funding1.setReportingOrganization(orgs.getWorldBank());

        AmpComponent component1 = new AmpComponent();
        component1.setFundings(ImmutableSet.of(funding1));

        AmpOrgRole wbOrgRole = new AmpOrgRole();
        wbOrgRole.setRole(roles.getDonorRole());
        wbOrgRole.setOrganisation(orgs.getWorldBank());

        AmpActivity activity = new AmpActivity();
        activity.setComponents(ImmutableSet.of(component1));
        activity.setOrgrole(ImmutableSet.of(wbOrgRole));

        APIField activityField = getMetaModel();

        assertThat(getViolations(activityField, activity), emptyIterable());
    }

    @Test
    public void testDisabledComponents() {
        AmpActivity activity = activityWithOneUndeclaredOrg();

        TestFMService fmService = new TestFMService(ImmutableSet.of("/Activity Form/Components"));
        APIField activityField = getMetaModel(fmService);

        assertThat(getViolations(activityField, activity), emptyIterable());
    }

    @Test
    public void testDisabledCommitments() {
        AmpActivity activity = activityWithOneUndeclaredOrg();

        TestFMService fmService = new TestFMService(
                ImmutableSet.of("/Activity Form/Components/Component/Components Commitments/Commitment Table"));

        APIField activityField = getMetaModel(fmService);

        assertThat(getViolations(activityField, activity), emptyIterable());
    }

    @Test
    public void testDisabledComponentOrg() {
        AmpActivity activity = activityWithOneUndeclaredOrg();

        TestFMService fmService = new TestFMService(ImmutableSet.of(
                "/Activity Form/Components/Component/Components Commitments/Commitment Table/Component Organization"));

        APIField activityField = getMetaModel(fmService);

        assertThat(getViolations(activityField, activity), emptyIterable());
    }

    @Test
    public void testAllTransactionTypes() {
        HardcodedOrgs orgs = new HardcodedOrgs();
        HardcodedRoles roles = new HardcodedRoles();

        AmpComponentFunding funding1 = new AmpComponentFunding();
        funding1.setTransactionType(Constants.COMMITMENT);
        funding1.setReportingOrganization(orgs.getWorldBank());

        AmpComponentFunding funding2 = new AmpComponentFunding();
        funding2.setTransactionType(Constants.DISBURSEMENT);
        funding2.setReportingOrganization(orgs.getUsaid());

        AmpComponentFunding funding3 = new AmpComponentFunding();
        funding3.setTransactionType(Constants.EXPENDITURE);
        funding3.setReportingOrganization(orgs.getBelgium());

        AmpComponent component1 = new AmpComponent();
        component1.setFundings(ImmutableSet.of(funding1, funding2, funding3));

        AmpOrgRole wbOrgRole = new AmpOrgRole();
        wbOrgRole.setRole(roles.getDonorRole());
        wbOrgRole.setOrganisation(orgs.getWorldBank());

        AmpOrgRole usaidOrgRole = new AmpOrgRole();
        usaidOrgRole.setRole(roles.getDonorRole());
        usaidOrgRole.setOrganisation(orgs.getUsaid());

        AmpOrgRole belgiumOrgRole = new AmpOrgRole();
        belgiumOrgRole.setRole(roles.getDonorRole());
        belgiumOrgRole.setOrganisation(orgs.getBelgium());

        AmpActivity activity = new AmpActivity();
        activity.setComponents(ImmutableSet.of(component1));
        activity.setOrgrole(ImmutableSet.of(wbOrgRole, usaidOrgRole, belgiumOrgRole));

        APIField activityField = getMetaModel();

        assertThat(getViolations(activityField, activity), emptyIterable());
    }

    private AmpActivity activityWithOneUndeclaredOrg() {
        HardcodedOrgs orgs = new HardcodedOrgs();

        AmpComponentFunding funding1 = new AmpComponentFunding();
        funding1.setTransactionType(Constants.COMMITMENT);
        funding1.setReportingOrganization(orgs.getWorldBank());

        AmpComponent component1 = new AmpComponent();
        component1.setFundings(ImmutableSet.of(funding1));

        AmpActivity activity = new AmpActivity();
        activity.setComponents(ImmutableSet.of(component1));
        return activity;
    }

    private AmpActivity activityWithOneUndeclaredOrgInManyTransactions() {
        HardcodedOrgs orgs = new HardcodedOrgs();

        AmpComponentFunding funding1 = new AmpComponentFunding();
        funding1.setTransactionType(Constants.COMMITMENT);
        funding1.setReportingOrganization(orgs.getWorldBank());

        AmpComponentFunding funding2 = new AmpComponentFunding();
        funding2.setTransactionType(Constants.COMMITMENT);
        funding2.setReportingOrganization(orgs.getWorldBank());

        AmpComponent component1 = new AmpComponent();
        component1.setFundings(ImmutableSet.of(funding1, funding2));

        AmpActivity activity = new AmpActivity();
        activity.setComponents(ImmutableSet.of(component1));
        return activity;
    }

    private AmpActivity activityWithOneUndeclaredOrgWithDifferentPaths() {
        HardcodedOrgs orgs = new HardcodedOrgs();

        AmpComponentFunding funding1 = new AmpComponentFunding();
        funding1.setTransactionType(Constants.COMMITMENT);
        funding1.setReportingOrganization(orgs.getWorldBank());

        AmpComponentFunding funding2 = new AmpComponentFunding();
        funding2.setTransactionType(Constants.DISBURSEMENT);
        funding2.setReportingOrganization(orgs.getWorldBank());

        AmpComponent component1 = new AmpComponent();
        component1.setFundings(ImmutableSet.of(funding1, funding2));

        AmpActivity activity = new AmpActivity();
        activity.setComponents(ImmutableSet.of(component1));
        return activity;
    }

    private AmpActivity activityWithTwoUndeclaredOrgs() {
        HardcodedOrgs orgs = new HardcodedOrgs();

        AmpComponentFunding funding1 = new AmpComponentFunding();
        funding1.setTransactionType(Constants.COMMITMENT);
        funding1.setReportingOrganization(orgs.getWorldBank());

        AmpComponentFunding funding2 = new AmpComponentFunding();
        funding2.setTransactionType(Constants.DISBURSEMENT);
        funding2.setReportingOrganization(orgs.getBelgium());

        AmpComponent component1 = new AmpComponent();
        component1.setFundings(ImmutableSet.of(funding1, funding2));

        AmpActivity activity = new AmpActivity();
        activity.setComponents(ImmutableSet.of(component1));
        return activity;
    }

    private Set<ConstraintViolation> getViolations(APIField activityField, AmpActivity activity) {
        Validator validator = new Validator();
        return validator.validate(activityField, activity);
    }

    private APIField getMetaModel() {
        return getMetaModel(new TestFMService());
    }

    private APIField getMetaModel(FMService fmService) {
        TestTranslatorService translatorService = new TestTranslatorService();
        TestFieldInfoProvider provider = new TestFieldInfoProvider();

        FieldsEnumerator fieldsEnumerator = new FieldsEnumerator(provider, fmService, translatorService, name -> true);

        return fieldsEnumerator.getMetaModel(AmpActivityFields.class);
    }
}
